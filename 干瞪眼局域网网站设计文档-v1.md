# 干瞪眼局域网网站设计文档（V1）

## 1. 目标与范围

### 1.1 项目目标
- 在局域网内提供一个网页游戏系统，玩家通过浏览器访问同一地址即可参与干瞪眼。
- 支持创建/加入房间、输入昵称（可随机生成）、开始对局、按固定房规进行出牌与计分。
- 对局结束后保留本房间的玩家累计分，方便连续多局。

### 1.2 V1 范围（本阶段实现）
- 房间大厅：创建房间、加入房间、玩家列表、房主开始游戏。
- 昵称系统：手动输入昵称 + 一键随机昵称。
- 发牌与回合：随机出牌顺序，按顺序行动。
- 对局流程：出牌、过牌、回合结束、摸牌、胜负判定。
- 计分系统：按已确认规则结算并记录房间累计分。
- 局域网部署：同网段设备可通过 IP + 端口访问。

### 1.3 暂不纳入 V1
- 账号登录/注册、云端持久化。
- 断线重连后的完整状态恢复（V1 先做弱恢复：短时间内同名重进可接回）。
- 语音聊天、观战、战绩排行榜网站。

---

## 2. 游戏规则基线（系统内置）

V1 以文档 `象山干瞪眼房规-最终稿.md` 为唯一规则源，核心规则摘要如下：
- 人数：3-5 人；1 副 54 张。
- 发牌：庄家 6 张，其余 5 张。
- 王为百搭，可单出。
- 炸弹：三张同点数。
- 不强制有大必出。
- 一轮结束后仅本轮最大者摸 1 张。
- 炸弹计数 `N` = 本局实际打出的炸弹总次数。
- 当局基础分：`手牌数量 × 2^N`。
- 留王或留炸弹：该玩家当局分 ×2。
- 对冲：赢家赢分 = 其余玩家当局分之和。

说明：规则解释冲突时，以该房规文档和“房主开局前确认项”为准。

---

## 3. 用户角色与核心流程

### 3.1 角色
- 房主：创建房间、开始新局、解散房间（可选）。
- 玩家：加入房间、准备/等待、出牌、查看结算。

### 3.2 核心流程
1. 玩家访问首页，输入昵称或点击“随机昵称”。
2. 玩家创建房间或输入房间码加入房间。
3. 房间内凑齐 3-5 人，房主点击“开始游戏”。
4. 系统随机座次（也可理解为随机出牌顺序）。
5. 发牌并进入出牌阶段。
6. 按规则出牌/过牌，系统自动判定合法性与轮转。
7. 产生赢家后进入结算，显示本局分与累计分。
8. 房主可发起下一局（同房间同玩家继续）。

---

## 4. 系统架构设计

### 4.1 架构总览
- 前端：HTML/CSS/JavaScript（可先原生，后续可迁移 Vue/React）。
- 后端：Node.js + WebSocket（推荐 `ws` 或 `socket.io`）。
- 通信：
- HTTP：页面与静态资源。
- WebSocket：房间状态同步、出牌动作广播、计分更新。

### 4.2 为什么选 WebSocket
- 对局是强实时场景（出牌、倒计时、轮转需要低延迟推送）。
- 局域网环境下 WebSocket 成本低、部署简单。

### 4.3 局域网部署模型
- 服务端运行在一台主机（如 `192.168.1.20:3000`）。
- 其他设备通过浏览器访问该地址。
- 同网段内无需公网与域名。

---

## 5. 前端页面与交互设计

### 5.1 页面结构
- 首页（昵称 + 创建/加入）。
- 房间页（玩家列表、房间码、开始按钮、累计分面板）。
- 对局页（手牌区、桌面牌区、操作按钮、提示区）。
- 结算弹窗（本局得分变化 + 总分榜）。

### 5.2 关键交互
- 昵称输入框旁提供“随机昵称”按钮，点击后从词库生成（如“海风-27”）。
- 当前轮到谁时高亮其头像/昵称。
- 出牌前前端先做一次本地规则校验，失败直接提示原因。
- 所有关键结果以后端判定为准，前端仅做体验增强。

### 5.3 响应式要求
- 手机横屏优先，兼容桌面。
- 手牌支持点选/取消，防误触。

---

## 6. 后端模块设计

### 6.1 模块划分
- `RoomManager`：创建、查找、销毁房间；维护房间码。
- `PlayerSession`：玩家连接、断开、重连映射。
- `GameEngine`：发牌、牌型判定、回合推进、胜负与计分。
- `RuleValidator`：统一合法性校验。
- `ScoreBoard`：维护当前房间累计分。

### 6.2 房间状态机（建议）
- `waiting`：等待玩家。
- `ready`：人数满足可开局。
- `playing`：对局中。
- `settlement`：结算展示中。
- `closed`：房间关闭。

### 6.3 对局状态最小字段
- `roomId`
- `players[]`（id, nickname, seatIndex, connected）
- `deck[]`
- `hands{playerId: cards[]}`
- `turnPlayerId`
- `lastPlay`（牌型、出牌者、牌列表）
- `passChain`
- `roundWinnerId`
- `bombCountN`
- `status`

---

## 7. 通信协议（事件草案）

### 7.1 Client -> Server
- `lobby:create_room` `{ nickname }`
- `lobby:join_room` `{ roomId, nickname }`
- `room:start_game` `{ roomId }`
- `game:play_cards` `{ roomId, cards[] }`
- `game:pass` `{ roomId }`
- `room:next_round` `{ roomId }`

### 7.2 Server -> Client
- `room:state` `{ ...roomState }`
- `game:dealt` `{ yourHand, turnPlayerId, seatOrder[] }`
- `game:played` `{ playerId, cards, nextTurnPlayerId }`
- `game:round_end` `{ roundWinnerId, drawResult }`
- `game:settlement` `{ winnerId, scores, totals, bombCountN }`
- `error` `{ code, message }`

### 7.3 设计原则
- 所有动作以服务端顺序号（`actionSeq`）串行处理，避免并发抢操作。
- 每次广播尽量发送“完整可渲染状态”，降低前端状态错乱风险。

---

## 8. 规则引擎要点

### 8.1 牌表示建议
- 牌对象：`{ id, rank, suit, jokerType }`。
- `id` 全局唯一，用于前端选牌与回放。

### 8.2 王百搭处理
- 校验器在判定牌型时允许王替代目标点数。
- 一次出牌内，王的替代映射固定，随出牌结果一起写入日志。

### 8.3 炸弹与计分
- 判定“本次出牌是否炸弹”，若是则 `bombCountN += 1`。
- 结算时按 `手牌数量 × 2^N`。
- 检查“留王/留炸弹”后执行 `×2`。
- 最后按对冲规则生成赢家+输家分。

---

## 9. 数据持久化策略（V1）

### 9.1 V1 建议
- 房间与对局状态：内存存储。
- 可选轻量落盘：JSON 文件记录最近若干房间累计分（防服务重启全丢）。

### 9.2 后续可升级
- SQLite：保存房间历史、玩家总榜、对局记录。

---

## 10. 异常与边界处理

- 玩家断线：标记 `connected=false`，短时间允许重连接回。
- 房主断线：可自动转移房主给下一个在线玩家。
- 非法操作：
- 非当前玩家出牌。
- 牌不在手里。
- 牌型非法或压不住上家。
- 统一返回 `error` 事件并保留当前局面不变。

---

## 11. 安全与公平

- 发牌、判型、结算全部在服务端执行。
- 前端不保存其他玩家完整手牌。
- 客户端任何“合法”提示仅供参考，不作为最终判定。

---

## 12. 开发计划（建议）

### Phase 1：房间与连接（1-2 天）
- 建立 Node.js 服务 + WebSocket。
- 实现创建/加入房间、昵称与随机昵称。
- 完成房间玩家列表实时同步。

### Phase 2：核心对局（2-4 天）
- 完成发牌、随机出牌顺序、出牌/过牌轮转。
- 完成基础牌型判定（含王百搭、三张炸弹）。
- 完成回合结束“仅最大者摸牌”。

### Phase 3：结算与稳定性（1-2 天）
- 实现炸弹计数 N、当局得分与对冲。
- 实现留王/留炸弹翻倍。
- 断线、非法操作、房主转移处理。

### Phase 4：体验优化（1-2 天）
- 手牌动画与出牌反馈。
- 移动端布局优化。
- 对局日志与结算展示优化。

---

## 13. 验收标准（V1）

- 3-5 个设备在同一局域网可稳定加入同一房间。
- 房主可开局，系统能随机顺序并正确发牌。
- 全流程可从开局打到结算，无需人工干预。
- 计分符合：`手牌数量 × 2^N`、留王/留炸弹 ×2、对冲结算。
- 连续 5 局后累计分正确，无明显状态错乱。

---

## 14. 建议技术栈（可直接开工）

- 前端：原生 HTML/CSS/JS（V1 快速交付）
- 后端：Node.js + Express + Socket.IO
- 存储：内存 + JSON（V1），后续升级 SQLite
- 部署：同网段主机 `node server.js` 启动

---

## 15. 后续可扩展方向

- 房间密码、观战模式、管理员踢人。
- 自动托管（玩家超时自动过牌）。
- 战绩榜、回放、导出结算。
- 语音房与快捷聊天。

